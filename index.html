<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>RULEOUT</title>
<style>
:root {
  --bg:#050b1a;
  --panel:#0b1630;
  --card:#0f1f45;
  --text:#e8f0ff;
  --muted:#8fa6ff;
  --accent:#3b82f6;
  --accent-soft:#60a5fa;
  --danger:#fb7185;
  --success:#34d399;
}
* { box-sizing:border-box; }
body {
  margin:0;
  min-height:100vh;
  font-family:system-ui,-apple-system,Segoe UI,sans-serif;
  background:radial-gradient(1000px 600px at top,#0f2a66,var(--bg));
  color:var(--text);
  overflow-x:hidden;
}
.start {
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:26px;
  background:radial-gradient(900px 500px at center,#123a8c,#050b1a);
}
.start h1 { font-size:68px; letter-spacing:.35em; }
.start p { max-width:560px; text-align:center; color:var(--muted); font-size:18px; }
.start button {
  padding:18px 66px;
  font-size:22px;
  border:none;
  border-radius:999px;
  cursor:pointer;
  font-weight:800;
}
#startPlayBtn { background:linear-gradient(135deg,var(--accent),var(--accent-soft)); color:white; }
.google-signin {
  padding:18px 66px;
  background:linear-gradient(135deg,var(--accent),var(--accent-soft));
  color:white;
  border:none;
  border-radius:999px;
  font-size:18px;
  font-weight:800;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:10px;
  box-shadow:0 8px 24px rgba(0,0,0,.4);
  transition:all .2s;
}
.google-signin:hover { box-shadow:0 12px 32px rgba(0,0,0,.5); transform:translateY(-2px); }
.google-icon { width:20px; height:20px; filter:brightness(0) invert(1); }
.signout-btn {
  position:fixed;
  top:16px;
  left:16px;
  padding:6px 10px;
  background:rgba(255,255,255,.08);
  color:var(--muted);
  border:1px solid rgba(255,255,255,.15);
  border-radius:6px;
  font-size:11px;
  font-weight:600;
  cursor:pointer;
  backdrop-filter:blur(10px);
  transition:all .2s;
  z-index:1000;
}
.signout-btn:hover { background:rgba(255,255,255,.15); border-color:rgba(255,255,255,.25); color:var(--text); }
.help-btn {
  position:fixed;
  bottom:16px;
  left:16px;
  width:40px;
  height:40px;
  background:rgba(59,130,246,.2);
  color:var(--accent-soft);
  border:2px solid var(--accent);
  border-radius:50%;
  font-size:20px;
  font-weight:800;
  cursor:pointer;
  backdrop-filter:blur(10px);
  transition:all .2s;
  z-index:1000;
  display:flex;
  align-items:center;
  justify-content:center;
}
.help-btn:hover { background:rgba(59,130,246,.3); transform:scale(1.1); }
.help-btn:disabled { opacity:.3; cursor:not-allowed; transform:scale(1); }
.game { display:none; padding:42px; min-height:100vh; }
.container { max-width:1100px; margin:0 auto; }
.progress-section {
  margin-bottom:32px;
  background:linear-gradient(180deg,var(--card),var(--panel));
  padding:24px 34px;
  border-radius:24px;
  box-shadow:0 16px 32px rgba(0,0,0,.3);
}
.category-title { font-size:24px; font-weight:900; color:var(--accent-soft); margin-bottom:12px; text-transform:uppercase; letter-spacing:.1em; }
.stats-row { display:flex; gap:32px; align-items:center; flex-wrap:wrap; }
.stat { display:flex; flex-direction:column; gap:4px; }
.stat-label { font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; }
.stat-value { font-size:32px; font-weight:900; color:var(--success); }
.progress-bar { width:100%; height:12px; background:rgba(0,0,0,.3); border-radius:999px; overflow:hidden; margin-top:16px; }
.progress-fill { height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-soft)); transition:width .3s ease; border-radius:999px; }
.puzzle-grid { display:grid; grid-template-columns:1.3fr .7fr; gap:44px; margin-bottom:32px; }
.card { background:linear-gradient(180deg,var(--card),var(--panel)); padding:34px; border-radius:24px; box-shadow:0 32px 64px rgba(0,0,0,.45); }
.clue { font-size:19px; margin-bottom:16px; line-height:1.6; }
.constraints { color:var(--danger); line-height:1.8; font-size:15px; margin-bottom:26px; }
.counter { font-size:34px; font-weight:900; color:var(--accent-soft); }
input { width:100%; padding:18px; font-size:20px; border-radius:16px; border:none; outline:none; background:#020617; color:var(--text); text-align:center; }
button { width:100%; padding:18px; margin-top:16px; border-radius:16px; border:none; font-weight:900; cursor:pointer; }
.submit { background:var(--accent); color:white; }
.message { margin-top:20px; min-height:32px; text-align:center; font-size:16px; }
.success-overlay {
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:20px;
  background:rgba(16,185,129,.15);
  backdrop-filter:blur(8px);
  z-index:999;
  animation:fadeIn .3s ease;
}
.success-text {
  font-size:84px;
  font-weight:900;
  letter-spacing:.25em;
  color:var(--success);
  text-shadow:0 0 30px rgba(16,185,129,.5);
  animation:pop 2.5s ease forwards;
}
.points-earned {
  font-size:48px;
  font-weight:800;
  color:var(--accent-soft);
  animation:slideUp .5s ease .3s both;
}
.confetti {
  position:absolute;
  width:10px;
  height:10px;
  background:var(--success);
  animation:confettiFall 2s ease-out forwards;
}
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
@keyframes pop { 0%{opacity:0;transform:scale(.6)} 15%{opacity:1;transform:scale(1.1)} 85%{opacity:1;transform:scale(1)} 100%{opacity:0;transform:scale(1.05)} }
@keyframes slideUp { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }
@keyframes confettiFall { to{transform:translateY(100vh) rotate(360deg); opacity:0;} }
@media(max-width:768px){ .puzzle-grid{grid-template-columns:1fr} .stats-row{justify-content:space-between} }
</style>
</head>
<body>

<div class="start" id="start">
 <h1>RULEOUT</h1>
 <p>Decode the clues. Follow the rules. Guess the word. 5 attempts to crack each puzzle. New challenges daily.</p>
 <button id="startPlayBtn" style="display:none" onclick="startGame()">â–¶ PLAY</button>
 <button class="google-signin" id="authBtn" onclick="handleAuth()">
  <svg class="google-icon" viewBox="0 0 24 24">
   <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
   <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
   <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
   <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
  </svg>
  <span id="authText">Sign in with Google</span>
 </button>
</div>

<div class="game" id="game">
 <button class="signout-btn" id="signoutBtn" style="display:none" onclick="signOutUser()">Sign Out</button>
 <button class="help-btn" id="helpBtn" onclick="getHint()" title="Get an extra clue">?</button>
 <div class="container">
  <div class="progress-section">
   <div class="category-title" id="categoryTitle">STATS</div>
   <div class="stats-row">
    <div class="stat"><div class="stat-label">Total Points</div><div class="stat-value" id="totalPoints">0</div></div>
    <div class="stat"><div class="stat-label">Streak</div><div class="stat-value" id="streakDisplay">0</div></div>
    <div class="stat"><div class="stat-label">Puzzle</div><div class="stat-value" id="puzzleNum">1/5</div></div>
   </div>
   <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
  </div>
  <div class="puzzle-grid">
   <div class="card">
    <div style="font-size:14px;color:var(--accent-soft);font-weight:700;margin-bottom:12px;text-transform:uppercase" id="currentCategoryDisplay">SPORTS</div>
    <div class="clue" id="clue"></div>
    <div class="constraints" id="constraints"></div>
    <div class="counter" id="counter"></div>
   </div>
   <div class="card">
    <input id="guess" placeholder="Type the word that fits"/>
    <button class="submit" onclick="submitGuess()">Submit</button>
    <div class="message" id="message"></div>
   </div>
  </div>
 </div>
</div>

<div class="start" id="victory" style="display:none">
 <h1 style="font-size:72px;color:var(--success);text-shadow:0 0 40px rgba(52,211,153,.6)">ðŸŽ‰</h1>
 <h2 style="font-size:48px;margin:0">YOU BEAT RULEOUT!</h2>
 <p style="font-size:24px;color:var(--accent-soft);margin:20px 0">Final Score: <span id="finalScore" style="font-weight:900">0</span> points</p>
 <button style="background:linear-gradient(135deg,var(--success),#10b981);color:white" onclick="playAgain()">â–¶ PLAY AGAIN</button>
</div>

<script type="module">
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Firebase Modular (using a stable recent version)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDpncc72bVroaBydIlfk4f4Il0ag0dPPP0",
  authDomain: "ruleout-14bdb.firebaseapp.com",
  projectId: "ruleout-14bdb",
  storageBucket: "ruleout-14bdb.firebasestorage.app",
  messagingSenderId: "497779197134",
  appId: "1:497779197134:web:3194021bd696fa1b437c9f",
  measurementId: "G-7BBMSV6GZJ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

let currentUser = null;
let authReady = false;

onAuthStateChanged(auth, (user) => {
  currentUser = user;
  authReady = true;
  updateAuthButton();
  if (user && document.getElementById("game").style.display === "block") {
    loadProgress();
  }
});

function updateAuthButton() {
  if (!authReady) return;
  const authBtn = document.getElementById('authBtn');
  const playBtn = document.getElementById('startPlayBtn');
  const signoutBtn = document.getElementById('signoutBtn');
  if (currentUser) {
    authBtn.style.display = 'none';
    playBtn.style.display = 'flex';
    signoutBtn.style.display = 'block';
  } else {
    authBtn.style.display = 'flex';
    playBtn.style.display = 'none';
    signoutBtn.style.display = 'none';
  }
}

window.signOutUser = () => {
  signOut(auth).then(() => {
    localStorage.removeItem('ruleout_progress');
    window.location.reload();
  }).catch(err => console.error("Sign out error:", err));
};

window.handleAuth = () => {
  if (currentUser) {
    signOutUser();
  } else {
    signInWithPopup(auth, provider)
      .then(result => console.log('Signed in:', result.user.displayName))
      .catch(error => {
        console.error('Sign-in error:', error);
        alert('Sign-in failed: ' + error.message);
      });
  }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GAME LOGIC
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const maxGuesses = 5;
let puzzles = [];
let categoryIndex = 0;
let puzzleIndex = 0;
let guessesLeft = maxGuesses;
let constraints = [];
let currentCategory = "";
let totalPoints = 0;
let streak = 0;
let hintUsed = false;

const WORD_CATEGORIES = [
  {
    name: "SPORTS",
    words: [
      {clues: ["Racket sport", "Fast indoor game", "Shuttlecock"], a: "badminton"},
      {clues: ["Water rescue", "Board and waves", "Hang ten"], a: "surfing"},
      {clues: ["Stick and ball", "Field goals", "Lacrosse cousin"], a: "hurling"},
      {clues: ["Cycling race", "Tour de France", "Yellow jersey"], a: "bicycling"},
      {clues: ["Wrestling style", "Pinned shoulders", "Freestyle or Greco"], a: "wrestling"},
      {clues: ["Archery target", "Bullseye hit", "Bow and arrow"], a: "archery"},
      {clues: ["Paddle game", "Table tennis", "Spin and smash"], a: "pingpong"},
      {clues: ["Equestrian jump", "Show ring", "Triple bar"], a: "jumping"},
      {clues: ["Fencing weapon", "Thrust and parry", "Ã‰pÃ©e or foil"], a: "sabre"},
      {clues: ["Rowing boat", "Crew sport", "Coxswain calls"], a: "sculling"}
    ]
  },
  {
    name: "FOOD",
    words: [
      {clues: ["Spicy sausage", "Paella ingredient", "Spanish chorizo kin"], a: "linguica"},
      {clues: ["Snail dish", "French delicacy", "Garlic butter"], a: "escargot"},
      {clues: ["Layered pasta", "Oven-baked", "BÃ©chamel sauce"], a: "lasagna"},
      {clues: ["Spiced rice dish", "Saffron threads", "Indian feast"], a: "biryani"},
      {clues: ["Pickled herring", "Scandinavian", "Sour cream"], a: "rollmops"},
      {clues: ["Dried plums", "Prune source", "Sweet chewy"], a: "prunes"},
      {clues: ["Greek yogurt dip", "Cucumber garlic", "Pita dip"], a: "tzatziki"},
      {clues: ["Japanese buckwheat noodles", "Cold dipping sauce", "Zaru style"], a: "soba"},
      {clues: ["Stuffed vine leaves", "Mediterranean", "Rice filling"], a: "dolma"},
      {clues: ["Fermented soybean paste", "Umami base", "Miso soup"], a: "miso"}
    ]
  },
  {
    name: "HISTORY",
    words: [
      {clues: ["Renaissance painter", "School of Athens", "Vatican"], a: "raphael"},
      {clues: ["Mongol conqueror", "Khan empire", "Silk Road"], a: "genghis"},
      {clues: ["Enlightenment thinker", "Social contract", "Leviathan"], a: "hobbes"},
      {clues: ["Ancient trade route", "Silk and spices", "China to Europe"], a: "silkroad"},
      {clues: ["Viking explorer", "North America", "Leif Erikson kin"], a: "thorvald"},
      {clues: ["Byzantine emperor", "Hagia Sophia", "Justinian code"], a: "justinian"},
      {clues: ["Greek warrior king", "Persian wars", "Hot gates"], a: "leonidas"}
    ]
  },
  {
    name: "POLITICS",
    words: [
      {clues: ["Sudden power grab", "Military takeover", "Junta rule"], a: "putsch"},
      {clues: ["Diplomatic meeting", "Summit talks", "G7 gathering"], a: "summit"},
      {clues: ["Political refuge", "Asylum seeker", "Exile status"], a: "asylum"},
      {clues: ["Voter suppression", "Gerrymander kin", "Poll tax"], a: "franchise"},
      {clues: ["Election system", "Proportional rep", "First past post"], a: "plurality"},
      {clues: ["Cabinet member", "Foreign affairs", "State dept"], a: "secretary"},
      {clues: ["Formal agreement", "Ratified pact", "Geneva"], a: "treaty"},
      {clues: ["Ideology", "Collective ownership", "Marxist"], a: "socialism"}
    ]
  },
  {
    name: "MATH",
    words: [
      {clues: ["Angle less than 90", "Acute kin", "Right angle base"], a: "obtuse"},
      {clues: ["Curve shape", "Parabola kin", "Circle section"], a: "ellipse"},
      {clues: ["Three dimensions", "Volume measure", "Cubic units"], a: "prism"},
      {clues: ["Data average", "Mean type", "Median mode"], a: "arithmetic"},
      {clues: ["Opposite over hypotenuse", "Trig function", "Sine cousin"], a: "cosine"},
      {clues: ["Repeating decimal", "Bar over digit", "Rational"], a: "recurring"},
      {clues: ["Shape with equal sides", "Regular polygon", "Equilateral"], a: "hexagon"},
      {clues: ["Probability event", "Mutually exclusive", "Addition rule"], a: "disjoint"},
      {clues: ["Single number", "Matrix multiply", "Dot product"], a: "scalar"}
    ]
  }
];

function seed() {
  const d = new Date();
  return d.getFullYear() * 1000 + d.getMonth() * 50 + d.getDate();
}

function rng(s) {
  return () => (s = (s * 9301 + 49297) % 233280) / 233280;
}

async function startGame() {
  document.getElementById("start").style.display = "none";
  document.getElementById("game").style.display = "block";
  const loaded = await loadProgress();
  if (!loaded) {
    categoryIndex = 0;
    puzzleIndex = 0;
    guessesLeft = maxGuesses;
    totalPoints = 0;
    streak = 0;
    hintUsed = false;
  }
  setup();
  load();
  updateStats();
}

function setup() {
  if (categoryIndex >= WORD_CATEGORIES.length) {
    showVictoryScreen();
    return;
  }
  currentCategory = WORD_CATEGORIES[categoryIndex].name;
  puzzles = WORD_CATEGORIES[categoryIndex].words;
}

function genConstraints(ans) {
  const valid = [];
  valid.push(`Exact length: ${ans.length}`);
  if (!/(.)\1/.test(ans)) valid.push("No double letters");
  if (/[aeiou]/.test(ans)) valid.push("Must contain at least one vowel");
  if (/^[aeiou]/.test(ans)) valid.push("First letter is a vowel");
  if (/[aeiou]$/.test(ans)) valid.push("Last letter is a vowel");
  const notIn = 'bcdfghjklmnpqrstvwxyz'.split('').filter(l => !ans.includes(l));
  if (notIn.length > 0) {
    const r = rng(seed() + puzzleIndex);
    const forbidden = notIn[Math.floor(r() * notIn.length)].toUpperCase();
    valid.push(`No letter: ${forbidden}`);
  }
  return valid.slice(0, 4);
}

function violates(w) {
  for (const r of constraints) {
    if (r.startsWith("Exact length") && w.length !== +r.split(": ")[1]) return "Wrong length";
    if (r === "No double letters" && /(.)\1/.test(w)) return "Double letters not allowed";
    if (r === "Must contain at least one vowel" && !/[aeiou]/.test(w)) return "Needs a vowel";
    if (r.startsWith("No letter:")) {
      const l = r.split(": ")[1].toLowerCase();
      if (w.includes(l)) return `Contains forbidden letter: ${l.toUpperCase()}`;
    }
    if (r === "First letter is a vowel" && !/^[aeiou]/.test(w)) return "Must start with vowel";
    if (r === "Last letter is a vowel" && !/[aeiou]$/.test(w)) return "Must end with vowel";
  }
  return null;
}

function update() {
  document.getElementById("counter").textContent = `Guesses left: ${guessesLeft}`;
}

function getHint() {
  if (hintUsed) return;
  hintUsed = true;
  const answer = puzzles[puzzleIndex].a;
  document.getElementById("message").textContent = `ðŸ’¡ Hint: starts with "${answer[0].toUpperCase()}"`;
  document.getElementById("message").style.color = "var(--accent-soft)";
  document.getElementById("helpBtn").disabled = true;
  totalPoints = Math.max(0, totalPoints - 20);
  updateStats();
  saveProgress();
}

function updateStats() {
  document.getElementById('categoryTitle').textContent = 'STATS';
  document.getElementById('totalPoints').textContent = totalPoints;
  document.getElementById('streakDisplay').textContent = streak;
  document.getElementById('puzzleNum').textContent = `${categoryIndex + 1}/${WORD_CATEGORIES.length} â€“ ${puzzleIndex + 1}/${puzzles.length}`;
  const total = WORD_CATEGORIES.reduce((s,c)=>s+c.words.length,0);
  let done = 0;
  for (let i = 0; i < categoryIndex; i++) done += WORD_CATEGORIES[i].words.length;
  done += puzzleIndex;
  document.getElementById('progressFill').style.width = (done / total * 100) + '%';
}

function submitGuess() {
  const input = document.getElementById("guess");
  const w = input.value.toLowerCase().trim();
  if (!w) return;
  guessesLeft--;
  update();
  saveProgress();
  const err = violates(w);
  input.value = "";
  const msg = document.getElementById("message");
  if (err) {
    msg.textContent = "âŒ " + err;
    if (guessesLeft === 0) fail();
    return;
  }
  if (w === puzzles[puzzleIndex].a) {
    win();
  } else {
    msg.textContent = "âŒ Wrong word";
    if (guessesLeft === 0) fail();
  }
}

function win() {
  const pointsEarned = 100 - ((maxGuesses - guessesLeft) * 10);
  totalPoints += pointsEarned;
  streak++;
  const overlay = document.createElement("div");
  overlay.className = "success-overlay";
  const txt = document.createElement("div");
  txt.className = "success-text";
  txt.textContent = "CORRECT!";
  const pts = document.createElement("div");
  pts.className = "points-earned";
  pts.textContent = `+${pointsEarned} points`;
  overlay.appendChild(txt);
  overlay.appendChild(pts);
  for (let i = 0; i < 50; i++) {
    const c = document.createElement("div");
    c.className = "confetti";
    c.style.left = Math.random()*100 + "%";
    c.style.background = ["#34d399","#3b82f6","#fb7185"][Math.floor(Math.random()*3)];
    c.style.animationDelay = Math.random()*0.3 + "s";
    overlay.appendChild(c);
  }
  document.body.appendChild(overlay);
  setTimeout(() => {
    overlay.remove();
    nextPuzzle();
  }, 2500);
}

function fail() {
  streak = 0;
  document.getElementById("message").textContent = "âŒ Answer: " + puzzles[puzzleIndex].a.toUpperCase();
  setTimeout(nextPuzzle, 2000);
}

function nextPuzzle() {
  puzzleIndex++;
  if (puzzleIndex >= puzzles.length) {
    categoryIndex++;
    puzzleIndex = 0;
    if (categoryIndex >= WORD_CATEGORIES.length) {
      showVictoryScreen();
      return;
    }
    setup();
  }
  load();
  updateStats();
}

function showVictoryScreen() {
  document.getElementById("game").style.display = "none";
  document.getElementById("victory").style.display = "flex";
  document.getElementById("finalScore").textContent = totalPoints;
}

function load() {
  guessesLeft = maxGuesses;
  hintUsed = false;
  document.getElementById("clue").textContent = puzzles[puzzleIndex].clues.join(" â€¢ ");
  constraints = genConstraints(puzzles[puzzleIndex].a);
  document.getElementById("constraints").innerHTML = constraints.map(r => "â€¢ " + r).join("<br>");
  document.getElementById("message").textContent = "";
  document.getElementById("message").style.color = "";
  document.getElementById("helpBtn").disabled = false;
  document.getElementById("currentCategoryDisplay").textContent = currentCategory;
  update();
  saveProgress();
}

function saveProgress() {
  const progress = {
    categoryIndex,
    puzzleIndex,
    guesses: guessesLeft,
    category: currentCategory,
    points: totalPoints,
    streak,
    hintUsed
  };
  localStorage.setItem('ruleout_progress', JSON.stringify(progress));
  if (currentUser) {
    setDoc(doc(db, "progress", currentUser.uid), progress)
      .catch(err => console.error("Save error:", err));
  }
}

async function loadProgress() {
  if (currentUser) {
    try {
      const snap = await getDoc(doc(db, "progress", currentUser.uid));
      if (snap.exists()) {
        const p = snap.data();
        categoryIndex = p.categoryIndex ?? 0;
        puzzleIndex = p.puzzleIndex ?? 0;
        guessesLeft = p.guesses ?? maxGuesses;
        currentCategory = p.category ?? "";
        totalPoints = p.points ?? 0;
        streak = p.streak ?? 0;
        hintUsed = p.hintUsed ?? false;
        if (hintUsed) document.getElementById("helpBtn").disabled = true;
        return true;
      }
    } catch (e) { console.error("Load error:", e); }
  }
  const saved = localStorage.getItem('ruleout_progress');
  if (saved) {
    try {
      const p = JSON.parse(saved);
      categoryIndex = p.categoryIndex ?? 0;
      puzzleIndex = p.puzzleIndex ?? 0;
      guessesLeft = p.guesses ?? maxGuesses;
      currentCategory = p.category ?? "";
      totalPoints = p.points ?? 0;
      streak = p.streak ?? 0;
      hintUsed = p.hintUsed ?? false;
      if (hintUsed) document.getElementById("helpBtn").disabled = true;
      return true;
    } catch (e) {}
  }
  return false;
}

function playAgain() {
  categoryIndex = 0;
  puzzleIndex = 0;
  guessesLeft = maxGuesses;
  totalPoints = 0;
  streak = 0;
  hintUsed = false;
  localStorage.removeItem('ruleout_progress');
  document.getElementById("victory").style.display = "none";
  document.getElementById("game").style.display = "block";
  setup();
  load();
  updateStats();
}

// Initial UI update
updateAuthButton();
</script>
</body>
</html>
