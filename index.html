<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>RULEOUT</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
:root{
 --bg:#050b1a;
 --panel:#0b1630;
 --card:#0f1f45;
 --text:#e8f0ff;
 --muted:#8fa6ff;
 --accent:#3b82f6;
 --accent-soft:#60a5fa;
 --danger:#fb7185;
 --success:#34d399;
}

*{box-sizing:border-box}

body{
 margin:0;
 min-height:100vh;
 font-family:system-ui,-apple-system,Segoe UI,sans-serif;
 background:radial-gradient(1000px 600px at top,#0f2a66,var(--bg));
 color:var(--text);
 overflow-x:hidden;
}

/* START */
.start{
 position:fixed;
 inset:0;
 display:flex;
 flex-direction:column;
 align-items:center;
 justify-content:center;
 gap:26px;
 background:radial-gradient(900px 500px at center,#123a8c,#050b1a);
}

.start h1{
 font-size:68px;
 letter-spacing:.35em;
}

.start p{
 max-width:560px;
 text-align:center;
 color:var(--muted);
 font-size:18px;
}

.start button{
 padding:18px 66px;
 font-size:22px;
 border:none;
 border-radius:999px;
 cursor:pointer;
 font-weight:800;
}

.start #startPlayBtn{
 background:linear-gradient(135deg,var(--accent),var(--accent-soft));
 color:white;
}

/* GOOGLE SIGN IN */
.google-signin{
 padding:18px 66px;
 background:linear-gradient(135deg,var(--accent),var(--accent-soft));
 color:white;
 border:none;
 border-radius:999px;
 font-size:18px;
 font-weight:800;
 cursor:pointer;
 display:flex;
 align-items:center;
 gap:10px;
 box-shadow:0 8px 24px rgba(0,0,0,.4);
 transition:all .2s;
}

.google-signin:hover{
 box-shadow:0 12px 32px rgba(0,0,0,.5);
 transform:translateY(-2px);
}

.google-icon{
 width:20px;
 height:20px;
 filter:brightness(0) invert(1);
}

/* SIGN OUT BUTTON */
.signout-btn{
 position:fixed;
 top:16px;
 left:16px;
 padding:6px 10px;
 background:rgba(255,255,255,.08);
 color:var(--muted);
 border:1px solid rgba(255,255,255,.15);
 border-radius:6px;
 font-size:11px;
 font-weight:600;
 cursor:pointer;
 backdrop-filter:blur(10px);
 transition:all .2s;
 z-index:1000;
}

.signout-btn:hover{
 background:rgba(255,255,255,.15);
 border-color:rgba(255,255,255,.25);
 color:var(--text);
}

/* HELP BUTTON */
.help-btn{
 position:fixed;
 bottom:16px;
 left:16px;
 width:40px;
 height:40px;
 background:rgba(59,130,246,.2);
 color:var(--accent-soft);
 border:2px solid var(--accent);
 border-radius:50%;
 font-size:20px;
 font-weight:800;
 cursor:pointer;
 backdrop-filter:blur(10px);
 transition:all .2s;
 z-index:1000;
 display:flex;
 align-items:center;
 justify-content:center;
}

.help-btn:hover{
 background:rgba(59,130,246,.3);
 transform:scale(1.1);
}

.help-btn:disabled{
 opacity:.3;
 cursor:not-allowed;
 transform:scale(1);
}

/* GAME */
.game{display:none;padding:42px;min-height:100vh}

.container{
 max-width:1100px;
 margin:0 auto;
}

/* PROGRESS BAR */
.progress-section{
 margin-bottom:32px;
 background:linear-gradient(180deg,var(--card),var(--panel));
 padding:24px 34px;
 border-radius:24px;
 box-shadow:0 16px 32px rgba(0,0,0,.3);
}

.category-title{
 font-size:24px;
 font-weight:900;
 color:var(--accent-soft);
 margin-bottom:12px;
 text-transform:uppercase;
 letter-spacing:.1em;
}

.stats-row{
 display:flex;
 gap:32px;
 align-items:center;
 flex-wrap:wrap;
}

.stat{
 display:flex;
 flex-direction:column;
 gap:4px;
}

.stat-label{
 font-size:12px;
 color:var(--muted);
 text-transform:uppercase;
 letter-spacing:.05em;
}

.stat-value{
 font-size:32px;
 font-weight:900;
 color:var(--success);
}

.progress-bar{
 width:100%;
 height:12px;
 background:rgba(0,0,0,.3);
 border-radius:999px;
 overflow:hidden;
 margin-top:16px;
}

.progress-fill{
 height:100%;
 background:linear-gradient(90deg,var(--accent),var(--accent-soft));
 transition:width .3s ease;
 border-radius:999px;
}

/* PUZZLE AREA */
.puzzle-grid{
 display:grid;
 grid-template-columns:1.3fr .7fr;
 gap:44px;
 margin-bottom:32px;
}

.card{
 background:linear-gradient(180deg,var(--card),var(--panel));
 padding:34px;
 border-radius:24px;
 box-shadow:0 32px 64px rgba(0,0,0,.45);
}

.clue{
 font-size:19px;
 margin-bottom:16px;
 line-height:1.6;
}

.constraints{
 color:var(--danger);
 line-height:1.8;
 font-size:15px;
 margin-bottom:26px;
}

.counter{
 font-size:34px;
 font-weight:900;
 color:var(--accent-soft);
}

/* INPUT */
input{
 width:100%;
 padding:18px;
 font-size:20px;
 border-radius:16px;
 border:none;
 outline:none;
 background:#020617;
 color:var(--text);
 text-align:center;
}

button{
 width:100%;
 padding:18px;
 margin-top:16px;
 border-radius:16px;
 border:none;
 font-weight:900;
 cursor:pointer;
}

.submit{background:var(--accent);color:white}
.next{background:#1e293b;color:var(--muted);display:none}

.message{
 margin-top:20px;
 min-height:32px;
 text-align:center;
 font-size:16px;
}

/* SUCCESS CELEBRATION */
.success-overlay{
 position:fixed;
 inset:0;
 display:flex;
 flex-direction:column;
 align-items:center;
 justify-content:center;
 gap:20px;
 background:rgba(16,185,129,.15);
 backdrop-filter:blur(8px);
 z-index:999;
 animation:fadeIn .3s ease;
}

.success-text{
 font-size:84px;
 font-weight:900;
 letter-spacing:.25em;
 color:var(--success);
 text-shadow:0 0 30px rgba(16,185,129,.5);
 animation:pop 2.5s ease forwards;
}

.points-earned{
 font-size:48px;
 font-weight:800;
 color:var(--accent-soft);
 animation:slideUp .5s ease .3s both;
}

.confetti{
 position:absolute;
 width:10px;
 height:10px;
 background:var(--success);
 animation:confettiFall 2s ease-out forwards;
}

@keyframes fadeIn{
 from{opacity:0}
 to{opacity:1}
}

@keyframes pop{
 0%{opacity:0;transform:scale(.6)}
 15%{opacity:1;transform:scale(1.1)}
 85%{opacity:1;transform:scale(1)}
 100%{opacity:0;transform:scale(1.05)}
}

@keyframes slideUp{
 from{opacity:0;transform:translateY(30px)}
 to{opacity:1;transform:translateY(0)}
}

@keyframes confettiFall{
 to{
  transform:translateY(100vh) rotate(360deg);
  opacity:0;
 }
}

@media(max-width:768px){
 .puzzle-grid{grid-template-columns:1fr}
 .stats-row{justify-content:space-between}
}
</style>
</head>

<body>

<div class="start" id="start">
 <h1>RULEOUT</h1>
 <p>Decode the clues. Follow the rules. Guess the word. 5 attempts to crack each puzzle. New challenges daily.</p>
 <button id="startPlayBtn" style="display:none" onclick="startGame()">‚ñ∂ PLAY</button>
 <button class="google-signin" id="authBtn" onclick="handleAuth()">
  <svg class="google-icon" viewBox="0 0 24 24">
   <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
   <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
   <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
   <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
  </svg>
  <span id="authText">Sign in with Google</span>
 </button>
</div>

<div class="game" id="game">
 <button class="signout-btn" id="signoutBtn" style="display:none" onclick="signOut()">Sign Out</button>
 <button class="help-btn" id="helpBtn" onclick="getHint()" title="Get an extra clue">?</button>
 
 <div class="container">
  
  <!-- PROGRESS SECTION -->
  <div class="progress-section">
   <div class="category-title" id="categoryTitle">STATS</div>
   <div class="stats-row">
    <div class="stat">
     <div class="stat-label">Total Points</div>
     <div class="stat-value" id="totalPoints">0</div>
    </div>
    <div class="stat">
     <div class="stat-label">Streak</div>
     <div class="stat-value" id="streakDisplay">0</div>
    </div>
    <div class="stat">
     <div class="stat-label">Puzzle</div>
     <div class="stat-value" id="puzzleNum">1/5</div>
    </div>
   </div>
   <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width:0%"></div>
   </div>
  </div>

  <!-- PUZZLE -->
  <div class="puzzle-grid">
   <div class="card">
    <div class="clue" id="clue"></div>
    <div class="constraints" id="constraints"></div>
    <div class="counter" id="counter"></div>
   </div>

   <div class="card">
    <input id="guess" placeholder="Type the word that fits"/>
    <button class="submit" onclick="submitGuess()">Submit</button>
    <div class="message" id="message"></div>
   </div>
  </div>

 </div>
</div>

<script>
// ============================================
// FIREBASE CONFIG
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyDpncc72bVroaBydIlfk4f4Il0ag0dPPP0",
  authDomain: "ruleout-14bdb.firebaseapp.com",
  projectId: "ruleout-14bdb",
  storageBucket: "ruleout-14bdb.firebasestorage.app",
  messagingSenderId: "497779197134",
  appId: "1:497779197134:web:3194021bd696fa1b437c9f",
  measurementId: "G-7BBMSV6GZJ"
};

let auth = null;
let currentUser = null;
let authReady = false;
let db = null;

try {
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  
  auth.onAuthStateChanged((user) => {
    currentUser = user;
    authReady = true;
    updateAuthButton();
    
    // Load progress when user signs in
    if (user && document.getElementById("game").style.display === "block") {
      loadProgress();
    }
  });
} catch (error) {
  console.log('Firebase initialization error:', error);
  authReady = true;
  updateAuthButton();
}

function updateAuthButton() {
  if (!authReady) return;
  
  const authBtn = document.getElementById('authBtn');
  const playBtn = document.getElementById('startPlayBtn');
  const signoutBtn = document.getElementById('signoutBtn');
  
  if (currentUser) {
    authBtn.style.display = 'none';
    playBtn.style.display = 'flex';
    if(signoutBtn) signoutBtn.style.display = 'block';
  } else {
    authBtn.style.display = 'flex';
    playBtn.style.display = 'none';
    if(signoutBtn) signoutBtn.style.display = 'none';
  }
}

function signOut() {
  if (auth && currentUser) {
    auth.signOut().then(() => {
      // Clear localStorage
      localStorage.removeItem('ruleout_progress');
      // Reload the page to reset everything
      window.location.reload();
    });
  }
}

function handleAuth() {
  if (!auth) {
    alert('Firebase authentication error. Check console for details.');
    return;
  }
  
  if (currentUser) {
    auth.signOut();
  } else {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then((result) => {
        console.log('Signed in:', result.user.displayName);
      })
      .catch((error) => {
        console.error('Sign-in error:', error);
        alert('Sign-in failed: ' + error.message);
      });
  }
}

// ============================================
// GAME CODE
// ============================================

const WORD_CATEGORIES = {
  "FOODS": [
    {clues: ["Bitter vegetable", "Caesar salad base", "Green leafy"], a: "romaine"},
    {clues: ["Spicy root", "Asian cooking", "Fresh or pickled"], a: "ginger"},
    {clues: ["Green fruit", "Pit inside", "Toast topping"], a: "avocado"},
    {clues: ["Italian cheese", "Pizza topping", "Stretchy when melted"], a: "mozzarella"},
    {clues: ["Breakfast grain", "Scottish dish", "Porridge base"], a: "oatmeal"},
    {clues: ["Sour liquid", "Salad dressing", "Fermented"], a: "vinegar"},
    {clues: ["Purple vegetable", "Eggplant", "Mediterranean dish"], a: "aubergine"},
    {clues: ["Sweet syrup", "Pancake topping", "Tree sap"], a: "maple"},
    {clues: ["Salty fish", "Pizza topping", "Small and oily"], a: "anchovy"},
    {clues: ["Italian dish", "Layered pasta", "Baked with cheese"], a: "lasagna"},
    {clues: ["Soft cheese", "Italian origin", "Fresh and mild"], a: "ricotta"},
    {clues: ["Green herb", "Fresh garnish", "Looks like parsley"], a: "cilantro"},
    {clues: ["Spicy condiment", "Hot sauce base", "Fermented peppers"], a: "sriracha"},
    {clues: ["Sweet fruit", "Dried snack", "Wrinkled skin"], a: "raisin"},
    {clues: ["Crunchy vegetable", "Green spears", "Spring harvest"], a: "asparagus"}
  ],
  "ANIMALS": [
    {clues: ["Striped mammal", "Forest dweller", "Masked face"], a: "raccoon"},
    {clues: ["Australian hopper", "Pouch for babies", "Long tail"], a: "kangaroo"},
    {clues: ["Slow mover", "Hangs upside down", "Three toed"], a: "sloth"},
    {clues: ["Arctic bird", "Black and white", "Cannot fly"], a: "penguin"},
    {clues: ["Long neck", "Spotted pattern", "Tallest animal"], a: "giraffe"},
    {clues: ["Ocean giant", "Filter feeder", "Largest animal"], a: "whale"},
    {clues: ["Smart bird", "Can mimic", "Colorful feathers"], a: "parrot"},
    {clues: ["Spiny creature", "Curls into ball", "Nocturnal"], a: "hedgehog"},
    {clues: ["Eight arms", "Very intelligent", "Changes color"], a: "octopus"},
    {clues: ["Horned animal", "Lives in Africa", "Thick skinned"], a: "rhinoceros"},
    {clues: ["Small primate", "Big eyes", "Nocturnal"], a: "lemur"},
    {clues: ["Pack hunter", "Howls at moon", "Dog ancestor"], a: "wolf"},
    {clues: ["Tusked mammal", "Lives in Arctic", "Marine animal"], a: "walrus"},
    {clues: ["Striped cat", "Fierce hunter", "Orange fur"], a: "tiger"},
    {clues: ["Flying mammal", "Uses echolocation", "Nocturnal"], a: "bat"}
  ],
  "STATS": [
    {clues: ["Data measure", "Average value", "Center point"], a: "mean"},
    {clues: ["Middle value", "Statistical term", "50th percentile"], a: "median"},
    {clues: ["Most frequent", "Common value", "Peak of curve"], a: "mode"},
    {clues: ["Spread measure", "Data scatter", "Not standard"], a: "range"},
    {clues: ["Upward pattern", "Growing over time", "Rising line"], a: "trend"},
    {clues: ["Relationship strength", "Two variables", "Positive or negative"], a: "correlation"},
    {clues: ["Whole group", "Everyone included", "Complete set"], a: "population"},
    {clues: ["Small group", "Subset of data", "Representative"], a: "sample"},
    {clues: ["Standard measure", "Deviation unit", "Normal distribution"], a: "sigma"},
    {clues: ["Data point", "Away from normal", "Unusual value"], a: "outlier"},
    {clues: ["Percentage chance", "Likelihood measure", "Between 0 and 1"], a: "probability"},
    {clues: ["Expected value", "Long run result", "Theoretical average"], a: "expectation"},
    {clues: ["Data spread", "Squared deviation", "Not standard"], a: "variance"},
    {clues: ["Bell shaped", "Common distribution", "Gaussian"], a: "normal"},
    {clues: ["Test result", "Reject null", "Statistical finding"], a: "significant"}
  ],
  "THINGS": [
    {clues: ["Writing surface", "Flip pages", "Spiral bound"], a: "notebook"},
    {clues: ["Kitchen tool", "Mixing device", "Electric or manual"], a: "blender"},
    {clues: ["Door fastener", "Needs password", "Digital security"], a: "keypad"},
    {clues: ["Time device", "Wakes you up", "Morning sound"], a: "alarm"},
    {clues: ["Comfort item", "Soft support", "Head rest"], a: "pillow"},
    {clues: ["Outdoor shelter", "Camping gear", "Fabric structure"], a: "tent"},
    {clues: ["Exercise equipment", "Cardio machine", "Belt moves"], a: "treadmill"},
    {clues: ["Storage furniture", "Wooden box", "Bedroom item"], a: "dresser"},
    {clues: ["Cooking vessel", "Has a lid", "Boils water"], a: "kettle"},
    {clues: ["Cleaning tool", "Sucks dirt", "Electric device"], a: "vacuum"},
    {clues: ["Garden tool", "Long handle", "Digs holes"], a: "shovel"},
    {clues: ["Music maker", "Strings attached", "Strumming"], a: "guitar"},
    {clues: ["Vision aid", "Two lenses", "Frames on nose"], a: "glasses"},
    {clues: ["Warm cover", "Bed layer", "Soft fabric"], a: "blanket"},
    {clues: ["Cutting board", "Kitchen surface", "Chop on this"], a: "chopping"}
  ],
  "ACTIONS": [
    {clues: ["Move quietly", "Tiptoe around", "Don't wake them"], a: "sneak"},
    {clues: ["Quick dash", "Running fast", "Race speed"], a: "sprint"},
    {clues: ["Spin motion", "Ballet move", "Rotate body"], a: "twirl"},
    {clues: ["Pull suddenly", "Sharp tug", "Quick jerk"], a: "yank"},
    {clues: ["Hold tight", "Firm grip", "Don't let go"], a: "grasp"},
    {clues: ["Look intently", "Fixed gaze", "Don't blink"], a: "stare"},
    {clues: ["Move upward", "Use ladder", "Scale mountain"], a: "climb"},
    {clues: ["Jump high", "Spring forward", "Bound motion"], a: "leap"},
    {clues: ["Wander aimlessly", "Explore casually", "No destination"], a: "roam"},
    {clues: ["Throw forcefully", "Baseball pitch", "Toss hard"], a: "hurl"},
    {clues: ["Walk heavily", "Loud steps", "Elephants do this"], a: "stomp"},
    {clues: ["Bend down", "Lower body", "Duck motion"], a: "crouch"},
    {clues: ["Victory shout", "Celebrate loudly", "Hooray"], a: "cheer"},
    {clues: ["Shiver motion", "Cold reaction", "Body shake"], a: "shudder"},
    {clues: ["Mix together", "Stir ingredients", "Combine well"], a: "blend"}
  ],
  "NATURE": [
    {clues: ["Water vapor", "Puffy white", "Floats in sky"], a: "cloud"},
    {clues: ["Mountain top", "Highest point", "Peak position"], a: "summit"},
    {clues: ["Deep valley", "Steep sides", "River carved"], a: "canyon"},
    {clues: ["Hot molten rock", "Volcanic flow", "Glowing orange"], a: "lava"},
    {clues: ["Ocean movement", "Crashing water", "Beach feature"], a: "wave"},
    {clues: ["Ice formation", "Hanging spike", "Winter danger"], a: "icicle"},
    {clues: ["Plant beginning", "Tiny start", "Grows into tree"], a: "seedling"},
    {clues: ["Storm cloud", "Dark and heavy", "Rain coming"], a: "nimbus"},
    {clues: ["Rock formation", "Underground cave", "Dripping water"], a: "stalactite"},
    {clues: ["Natural spring", "Hot water", "Volcanic feature"], a: "geyser"},
    {clues: ["Wind storm", "Spinning funnel", "Destructive"], a: "tornado"},
    {clues: ["Ocean floor", "Sandy bottom", "Underwater"], a: "seabed"},
    {clues: ["Tree liquid", "Sticky substance", "Makes syrup"], a: "sap"},
    {clues: ["Water body", "Calm surface", "Freshwater"], a: "lake"},
    {clues: ["Desert plant", "Has spines", "Stores water"], a: "cactus"}
  ]
};

const maxGuesses = 5;
let puzzles = [];
let i = 0;
let guessesLeft = 5;
let constraints = [];
let currentCategory = "";
let totalPoints = 0;
let streak = 0;
let hintUsed = false;

function seed(){
 const d = new Date();
 return d.getFullYear() * 1000 + d.getMonth() * 50 + d.getDate();
}

function rng(s){
 return () => (s = (s * 9301 + 49297) % 233280) / 233280;
}

async function startGame(){
 document.getElementById("start").style.display = "none";
 document.getElementById("game").style.display = "block";
 setup();
 
 const loaded = await loadProgress();
 if (!loaded) {
   i = 0;
   guessesLeft = maxGuesses;
   totalPoints = 0;
   streak = 0;
 }
 
 load();
 updateStats();
}

function setup(){
 const r = rng(seed());
 const categories = Object.keys(WORD_CATEGORIES);
 currentCategory = categories[Math.floor(r() * categories.length)];
 
 // Pick 5 random words from the category's larger pool
 const allWords = [...WORD_CATEGORIES[currentCategory]];
 puzzles = [];
 for(let j = 0; j < 5 && allWords.length > 0; j++){
  const idx = Math.floor(r() * allWords.length);
  puzzles.push(allWords.splice(idx, 1)[0]);
 }
}

function genConstraints(ans){
 const valid = [];
 valid.push(`Exact length: ${ans.length}`);
 
 const hasDoubles = /(.)\1/.test(ans);
 const vowels = ans.match(/[aeiou]/g) || [];
 const hasVowel = vowels.length > 0;
 const firstLetter = ans[0];
 const lastLetter = ans[ans.length - 1];
 const firstIsVowel = /[aeiou]/.test(firstLetter);
 const lastIsVowel = /[aeiou]/.test(lastLetter);
 
 if(!hasDoubles) valid.push("No double letters");
 if(hasVowel) valid.push("Must contain at least one vowel");
 if(firstIsVowel) valid.push("First letter is a vowel");
 if(lastIsVowel) valid.push("Last letter is a vowel");
 
 const notInWord = 'bcdfghjklmnpqrstvwxyz'.split('').filter(l => !ans.includes(l));
 if(notInWord.length > 0) {
  const r = rng(seed() + i);
  const randomLetter = notInWord[Math.floor(r() * notInWord.length)];
  valid.push(`No letter: ${randomLetter.toUpperCase()}`);
 }
 
 return valid.slice(0, 4);
}

function violates(w){
 for(const r of constraints){
  if(r.startsWith("Exact length") && w.length != +r.split(": ")[1]) return "Wrong length";
  if(r === "No double letters" && /(.)\1/.test(w)) return "Double letters not allowed";
  if(r === "Must contain at least one vowel" && !/[aeiou]/.test(w)) return "Needs a vowel";
  if(r.startsWith("No letter:")){
   const l = r.split(": ")[1].toLowerCase();
   if(w.includes(l)) return `Contains forbidden letter: ${l.toUpperCase()}`;
  }
  if(r === "First letter is a vowel" && !/^[aeiou]/.test(w)) return "Must start with vowel";
  if(r === "Last letter is a vowel" && !/[aeiou]$/.test(w)) return "Must end with vowel";
 }
 return null;
}

function update(){
 counter.textContent = `Guesses left: ${guessesLeft}`;
}

function getHint(){
 if(hintUsed) return;
 
 hintUsed = true;
 const answer = puzzles[i].a;
 const firstLetter = answer[0].toUpperCase();
 
 message.textContent = `üí° Hint: The word starts with "${firstLetter}"`;
 message.style.color = "var(--accent-soft)";
 
 // Disable the help button
 document.getElementById('helpBtn').disabled = true;
 
 // Deduct 20 points for using hint
 totalPoints = Math.max(0, totalPoints - 20);
 updateStats();
 saveProgress();
}

function updateStats(){
 document.getElementById('categoryTitle').textContent = 'STATS';
 document.getElementById('totalPoints').textContent = totalPoints;
 document.getElementById('streakDisplay').textContent = streak;
 document.getElementById('puzzleNum').textContent = `${i + 1}/${puzzles.length}`;
 
 const progress = ((i / puzzles.length) * 100);
 document.getElementById('progressFill').style.width = progress + '%';
}

function submitGuess(){
 const w = guess.value.toLowerCase().trim();
 if(!w) return;

 guessesLeft--;
 update();
 saveProgress();

 const err = violates(w);
 guess.value = "";

 if(err){
  message.textContent = "‚ùå " + err;
  if(guessesLeft === 0) fail();
  return;
 }

 if(w === puzzles[i].a){
  win();
 }else{
  message.textContent = "‚ùå Wrong word";
  if(guessesLeft === 0) fail();
 }
}

function win(){
 // Calculate points (start at 100, lose 10 per wrong guess)
 const pointsEarned = 100 - ((maxGuesses - guessesLeft) * 10);
 totalPoints += pointsEarned;
 streak++;
 
 // Create success overlay
 const overlay = document.createElement("div");
 overlay.className = "success-overlay";
 
 const successText = document.createElement("div");
 successText.className = "success-text";
 successText.textContent = "CORRECT!";
 
 const pointsText = document.createElement("div");
 pointsText.className = "points-earned";
 pointsText.textContent = `+${pointsEarned} points`;
 
 overlay.appendChild(successText);
 overlay.appendChild(pointsText);
 
 // Add confetti
 for(let j = 0; j < 50; j++){
  const confetti = document.createElement("div");
  confetti.className = "confetti";
  confetti.style.left = Math.random() * 100 + '%';
  confetti.style.background = ['#34d399', '#3b82f6', '#fb7185'][Math.floor(Math.random() * 3)];
  confetti.style.animationDelay = Math.random() * .3 + 's';
  confetti.style.animationDuration = (Math.random() * 1 + 1.5) + 's';
  overlay.appendChild(confetti);
 }
 
 document.body.appendChild(overlay);
 
 setTimeout(() => {
  overlay.remove();
  nextPuzzle();
 }, 2500);
}

function fail(){
 streak = 0;
 message.textContent = "‚ùå Answer: " + puzzles[i].a.toUpperCase();
 setTimeout(() => {
  nextPuzzle();
 }, 2000);
}

function nextPuzzle(){
 i++;
 if(i >= puzzles.length){
  clue.textContent = "üéâ Congratulations! You completed all puzzles in " + currentCategory + "!";
  constraintsEl.innerHTML = "";
  counter.textContent = `Final Score: ${totalPoints} points`;
  message.textContent = "New puzzles tomorrow!";
  saveProgress();
  return;
 }
 load();
 updateStats();
}

function load(){
 guessesLeft = maxGuesses;
 hintUsed = false;
 clue.textContent = puzzles[i].clues.join(" ‚Ä¢ ");
 constraints = genConstraints(puzzles[i].a);
 constraintsEl.innerHTML = constraints.map(r => "‚Ä¢ " + r).join("<br>");
 message.textContent = "";
 message.style.color = "";
 
 // Re-enable help button
 const helpBtn = document.getElementById('helpBtn');
 if(helpBtn) helpBtn.disabled = false;
 
 update();
 saveProgress();
}

function saveProgress() {
  const progress = {
    currentPuzzle: i,
    guesses: guessesLeft,
    category: currentCategory,
    points: totalPoints,
    streak: streak,
    puzzles: puzzles,
    hintUsed: hintUsed,
    date: new Date().toDateString()
  };
  
  // Save to localStorage as backup
  localStorage.setItem('ruleout_progress', JSON.stringify(progress));
  
  // Save to Firebase if user is signed in
  if (currentUser && db) {
    db.collection('progress').doc(currentUser.uid).set(progress)
      .catch((error) => {
        console.error('Error saving to Firebase:', error);
      });
  }
}

async function loadProgress() {
  const today = new Date().toDateString();
  
  // Try Firebase first if user is signed in
  if (currentUser && db) {
    try {
      const doc = await db.collection('progress').doc(currentUser.uid).get();
      if (doc.exists) {
        const progress = doc.data();
        
        if (progress.date === today && progress.puzzles) {
          i = progress.currentPuzzle;
          guessesLeft = progress.guesses;
          currentCategory = progress.category;
          totalPoints = progress.points || 0;
          streak = progress.streak || 0;
          puzzles = progress.puzzles;
          hintUsed = progress.hintUsed || false;
          
          // Update help button state
          if(hintUsed) {
            const helpBtn = document.getElementById('helpBtn');
            if(helpBtn) helpBtn.disabled = true;
          }
          
          return true;
        }
      }
    } catch (error) {
      console.error('Error loading from Firebase:', error);
    }
  }
  
  // Fall back to localStorage
  const saved = localStorage.getItem('ruleout_progress');
  if (saved) {
    const progress = JSON.parse(saved);
    
    if (progress.date === today && progress.puzzles) {
      i = progress.currentPuzzle;
      guessesLeft = progress.guesses;
      currentCategory = progress.category;
      totalPoints = progress.points || 0;
      streak = progress.streak || 0;
      puzzles = progress.puzzles;
      hintUsed = progress.hintUsed || false;
      
      // Update help button state
      if(hintUsed) {
        const helpBtn = document.getElementById('helpBtn');
        if(helpBtn) helpBtn.disabled = true;
      }
      
      return true;
    }
  }
  return false;
}

const clue = document.getElementById("clue");
const constraintsEl = document.getElementById("constraints");
const counter = document.getElementById("counter");
const message = document.getElementById("message");
const guess = document.getElementById("guess");
</script>

</body>
</html>
  
